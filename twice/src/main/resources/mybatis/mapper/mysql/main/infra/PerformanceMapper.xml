<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ezticket.infra.performance.PerformanceDao">

	<resultMap id="resultMapObj" type="com.ezticket.infra.performance.PerformanceDto"></resultMap>
	
	<!-- 관리자 리스트 -->
	<select id="selectList" resultMap="resultMapObj">
        SELECT
        	a.prSeq,
        	a.prTitle,
        	a.prperformanceType,
        	a.prViewingTime,
        	d.plplace,
        	a.prStartDate,
        	a.prEndDate,
        	a.prHostedPlanned,
        	a.prAgeLimit,
        	a.prAttenDance,
        	a.prDetails,
        	a.prRgstrDate,
        	a.prModifiedDate,
        	a.prdeleteNY
        	
        	FROM performanceList a
        	join placemapping b
        	on a.prSeq = b.prSeq
        	join place d
        	on d.plSeq = b.plSeq
        	WHERE 1=1
        	 <include refid="selectCommon" />   
         ORDER BY prSeq DESC
          limit #{rowNumToShow} offset #{startRnumForMysql}
    </select>
    
    
    <!-- 유저 리스트 -->
    <select id="usrselectList" resultMap="resultMapObj">
        SELECT
        	a.prSeq,
        	a.prTitle,
        	a.prperformanceType,
        	a.prViewingTime,
        	d.plplace,
        	a.prStartDate,
        	a.prEndDate,
        	a.prHostedPlanned,
        	a.prAgeLimit,
        	a.prAttenDance,
        	a.prDetails,
        	a.prRgstrDate,
        	a.prModifiedDate,
        	a.prdeleteNY
        	
        	FROM performanceList a
        	join placemapping b
        	on a.prSeq = b.prSeq
        	join place d
        	on d.plSeq = b.plSeq
        	WHERE 1=1 
        	
        	<if test="shperformance != null and !shperformance.equals('')">AND a.prperformanceType = #{shperformance}</if>   
         ORDER BY prSeq DESC
    </select>
    
    <!-- 유저 리스트 랭킹 -->
    <select id="usrselectRanking" resultMap="resultMapObj">
        SELECT
        	a.prSeq,
        	a.prTitle,
        	a.prperformanceType,
        	a.prViewingTime,
        	d.plplace,
        	a.prStartDate,
        	a.prEndDate,
        	a.prHostedPlanned,
        	a.prAgeLimit,
        	a.prAttenDance,
        	a.prDetails,
        	a.prRgstrDate,
        	a.prModifiedDate,
        	a.prdeleteNY
        	
        	FROM performanceList a
        	join placemapping b
        	on a.prSeq = b.prSeq
        	join place d
        	on d.plSeq = b.plSeq
        	WHERE 1=1
         ORDER BY a.prAttenDance DESC
    </select>
    
    
    <!-- 유저 배우 리스트 -->
    <select id="castMemberList" resultMap="resultMapObj">
        SELECT
			a.prSeq, 
			a.prTitle, 
			d.cmName,
			b.cpSeq,
			b.cpRole
			from performancelist a
			join castmembermapping b
			on a.prSeq = b.prSeq 
			join castmember d
			on d.cmseq = b.cmseq
			where b.prSeq = #{prSeq}
    </select>
    
    <select id="count"  resultType="Integer">
        SELECT
            COUNT(*)
        FROM
            performanceList a
            
            where 1=1
            <include refid="selectCommon" />  
    </select>
    
    <select id="selectOne">
    SELECT 
    		a.prSeq,
        	a.prTitle,
        	a.prperformanceType,
        	a.prViewingTime,
        	d.plplace,
        	a.prStartDate,
        	a.prEndDate,
        	a.prHostedPlanned,
        	a.prAgeLimit,
        	a.prAttenDance,
        	a.prDetails,
        	a.prRgstrDate,
        	a.prModifiedDate,
        	a.prdeleteNY
        	
        	FROM performanceList a
        	join placemapping b
        	on a.prSeq = b.prSeq
        	join place d
        	on d.plSeq = b.plSeq 
    WHERE 1=1 AND a.prSeq = #{prSeq}
    </select>
    
    <update id="update">
    
    UPDATE performanceList 
    SET
    prTitle = #{prTitle},
    prHostedPlanned = #{prHostedPlanned},
    prAgeLimit = #{prAgeLimit},
    prStartDate = #{prStartDate},
    prEndDate = #{prEndDate}
    WHERE prSeq = #{prSeq}
    
    </update>
    
     <insert id="insert">
    
    INSERT INTO performanceList
    (
    prTitle,
    prdeleteNY,
    prHostedPlanned,
    prAgeLimit,
    prStartDate,
    prEndDate
    )
    VALUES
    (
    #{prTitle}
    ,#{prdeleteNY}
    ,#{prHostedPlanned}
    ,#{prAgeLimit}
    ,#{prStartDate}
    ,#{prEndDate}
    )
    
    </insert>
    
    <update id="updatedelete">
    
    UPDATE performanceList
    SET
    prdeleteNY = 1
    WHERE prSeq = #{prSeq}
    
    </update>
    
    <delete id="delete">
    DELETE 
    FROM performanceList
    WHERE prSeq = #{prSeq}
    </delete>
    
    <sql id ="selectCommon">
   		<if test="shDelNy != null and !shDelNy.equals('')">AND prdeleteNY = #{shDelNy}</if>  
        	<if test="shAge != null and !shAge.equals('')">AND prAgeLimit = #{shAge}</if>   
                
				  <choose>
					<when test="shOptionDate == 1">AND prRgstrDate BETWEEN #{shDateStart} AND #{shDateEnd}</when>
					<when test="shOptionDate == 2">AND prModifiedDate BETWEEN #{shDateStart} AND #{shDateEnd}</when>  
				</choose>      
	        <choose>	
	            <when test="shOption == 1">AND prSeq = #{shValue}</when>
	            <when test="shOption == 2">AND prTitle LIKE CONCAT('%',#{shValue},'%')</when>
	        </choose> 
   </sql>


   <!--  ,(select count(aa.ifcdSeq) from infrCode aa where 1=1 and aa.ifcdDelNy = 0 and aa.ifcgSeq = a.ifcgSeq) as xifcdSeqCount -->
	  
</mapper>